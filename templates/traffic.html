
{% extends "base.html" %}

{% block title %}Mapa ruchu - Oceny Kierowców{% endblock %}

{% block head %}
<!-- Mapbox GL JS - Try multiple CDN sources for reliability -->
<link href='https://unpkg.com/mapbox-gl@2.15.0/dist/mapbox-gl.css' rel='stylesheet' />

<script>
// Load Mapbox GL JS with multiple fallback sources
(function loadMapboxGL() {
    const sources = [
        'https://unpkg.com/mapbox-gl@2.15.0/dist/mapbox-gl.js',
        'https://cdn.jsdelivr.net/npm/mapbox-gl@2.15.0/dist/mapbox-gl.min.js',
        'https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'
    ];
    
    let currentSource = 0;
    
    function tryLoadScript() {
        if (currentSource >= sources.length) {
            console.error('All Mapbox GL JS sources failed to load');
            showMapboxError();
            return;
        }
        
        const script = document.createElement('script');
        script.src = sources[currentSource];
        
        script.onload = function() {
            console.log(`Mapbox GL JS loaded successfully from source ${currentSource + 1}`);
            window.mapboxLoaded = true;
        };
        
        script.onerror = function() {
            console.warn(`Failed to load Mapbox GL JS from source ${currentSource + 1}, trying next...`);
            currentSource++;
            tryLoadScript();
        };
        
        document.head.appendChild(script);
    }
    
    function showMapboxError() {
        const container = document.getElementById('main-traffic-map');
        if (container) {
            container.innerHTML = `
                <div style="padding: 40px; text-align: center; color: #dc3545; background: #f8f9fa; border-radius: 8px; border: 2px dashed #dee2e6;">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <h4>Nie można załadować biblioteki map</h4>
                    <p class="mb-3">Sprawdź połączenie internetowe i spróbuj ponownie.</p>
                    <button class="btn btn-primary" onclick="location.reload()">
                        <i class="fas fa-sync me-1"></i>Odśwież stronę
                    </button>
                </div>
            `;
        }
    }
    
    tryLoadScript();
})();
</script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title mb-0">
                    <i class="fas fa-road me-2"></i>Mapa natężenia ruchu
                </h2>
            </div>
            <div class="card-body">
                <div class="alert alert-info" id="location-status">
                    <i class="fas fa-info-circle me-2"></i>
                    <span id="location-text">Mapa w ciemnym stylu TomTom pokazuje natężenie ruchu drogowego. Dane aktualizowane co 5 minut.</span>
                </div>
            </div>
        </div>
    </div>
</div>





<div class="row mt-4">
    <div class="col-lg-9">
        <div class="card">
            <div class="card-body p-0">
                <div style="height: 600px; width: 100%;">
                    <div id="main-traffic-map" style="height: 100%; width: 100%;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Statystyki ruchu
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span><span style="color: #28a745;">●</span> Płynny</span>
                        <span class="badge bg-success" id="smooth-count">25%</span>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span><span style="color: #ffc107;">●</span> Umiarkowany</span>
                        <span class="badge bg-warning" id="moderate-count">35%</span>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span><span style="color: #fd7e14;">●</span> Intensywny</span>
                        <span class="badge bg-warning" id="heavy-count">25%</span>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span><span style="color: #dc3545;">●</span> Korek</span>
                        <span class="badge bg-danger" id="jam-count">15%</span>
                    </div>
                </div>
                
                <hr>
                
                <div class="text-center">
                    <h6>Ostatnia aktualizacja</h6>
                    <p class="text-muted small" id="last-update">--:--:--</p>
                    <button class="btn btn-primary btn-sm" onclick="refreshMainTrafficMap()">
                        <i class="fas fa-sync me-1"></i>Odśwież
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>Aktywne zakłócenia
                </h5>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    <div class="list-group-item bg-transparent border-0 px-0 py-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">Aleje Jerozolimskie</h6>
                                <p class="mb-1 small">Intensywny ruch w kierunku centrum</p>
                                <small class="text-muted">5 min temu</small>
                            </div>
                            <span class="badge bg-danger">Korek</span>
                        </div>
                    </div>
                    <div class="list-group-item bg-transparent border-0 px-0 py-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">Marszałkowska</h6>
                                <p class="mb-1 small">Utrudnienia na wysokości Centralnego</p>
                                <small class="text-muted">12 min temu</small>
                            </div>
                            <span class="badge bg-warning">Intensywny</span>
                        </div>
                    </div>
                    <div class="list-group-item bg-transparent border-0 px-0 py-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">Wisłostrada</h6>
                                <p class="mb-1 small">Płynny ruch w obu kierunkach</p>
                                <small class="text-muted">3 min temu</small>
                            </div>
                            <span class="badge bg-success">Płynny</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Load traffic.js after app.js is already loaded -->
<script src="{{ url_for('static', filename='js/traffic.js') }}"></script>

<script>
let mainTrafficMap;

document.addEventListener('DOMContentLoaded', async function() {
    // Update location status
    updateLocationStatus();
    
    // Wait for scripts to fully load
    setTimeout(async () => {
        try {
            // Check if Mapbox GL JS is available
            if (typeof mapboxgl === 'undefined') {
                console.log('Waiting for Mapbox GL JS to load...');
                // Wait additional time for async loading
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
            
            if (typeof mapboxgl !== 'undefined') {
                // Initialize main traffic map
                mainTrafficMap = new TrafficMap('main-traffic-map', {
                    zoom: 12
                });
                
                // Update last update time
                updateLastUpdateTime();
                setInterval(updateLastUpdateTime, 60000); // Update every minute
            } else {
                throw new Error('Mapbox GL JS library not available');
            }
        } catch (error) {
            console.error('Failed to initialize traffic map:', error);
            const container = document.getElementById('main-traffic-map');
            if (container) {
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #dc3545; background: #f8f9fa; border-radius: 8px; border: 2px dashed #dee2e6;">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                        <h4>Nie udało się załadować mapy ruchu</h4>
                        <p class="mb-3">Problem z ładowaniem biblioteki map. Spróbuj ponownie.</p>
                        <button class="btn btn-primary" onclick="location.reload()">
                            <i class="fas fa-sync me-1"></i>Odśwież stronę
                        </button>
                    </div>
                `;
            }
        }
    }, 1500); // Wait 1.5 seconds for all scripts to load
});

function updateLocationStatus() {
    const locationText = document.getElementById('location-text');
    const locationStatus = document.getElementById('location-status');
    
    if (navigator.geolocation) {
        locationText.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Pobieranie Twojej lokalizacji...';
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                locationText.innerHTML = '<i class="fas fa-map-marker-alt me-2"></i>Mapa pokazuje natężenie ruchu w Twojej okolicy z TomTom API. Dane aktualizowane co 5 minut.';
                locationStatus.className = 'alert alert-success';
            },
            function(error) {
                locationText.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Nie można pobrać lokalizacji. Używana domyślna lokalizacja.';
                locationStatus.className = 'alert alert-warning';
            }
        );
    } else {
        locationText.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Geolokalizacja nie jest obsługiwana. Używana domyślna lokalizacja.';
        locationStatus.className = 'alert alert-warning';
    }
}

function refreshMainTrafficMap() {
    if (mainTrafficMap) {
        mainTrafficMap.refreshTrafficData();
        updateLastUpdateTime();
    }
}

function updateLastUpdateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('pl-PL');
    const lastUpdateElement = document.getElementById('last-update');
    if (lastUpdateElement) {
        lastUpdateElement.textContent = timeString;
    }
}
</script>
{% endblock %}
