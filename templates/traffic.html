
{% extends "base.html" %}

{% block title %}Mapa ruchu - Oceny Kierowców{% endblock %}

{% block head %}
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title mb-0">
                    <i class="fas fa-road me-2"></i>Mapa natężenia ruchu
                </h2>
            </div>
            <div class="card-body">
                <div class="alert alert-info" id="location-status">
                    <i class="fas fa-info-circle me-2"></i>
                    <span id="location-text">Mapa w ciemnym stylu TomTom pokazuje natężenie ruchu drogowego. Dane aktualizowane co 5 minut.</span>
                </div>
            </div>
        </div>
    </div>
</div>





<div class="row mt-4">
    <div class="col-lg-9">
        <div class="card">
            <div class="card-body p-0">
                <div style="height: 600px; width: 100%;">
                    <div id="main-traffic-map" style="height: 100%; width: 100%;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Statystyki ruchu
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span><span style="color: #28a745;">●</span> Płynny</span>
                        <span class="badge bg-success" id="smooth-count">25%</span>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span><span style="color: #ffc107;">●</span> Umiarkowany</span>
                        <span class="badge bg-warning" id="moderate-count">35%</span>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span><span style="color: #fd7e14;">●</span> Intensywny</span>
                        <span class="badge bg-warning" id="heavy-count">25%</span>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span><span style="color: #dc3545;">●</span> Korek</span>
                        <span class="badge bg-danger" id="jam-count">15%</span>
                    </div>
                </div>
                
                <hr>
                
                <div class="text-center">
                    <h6>Ostatnia aktualizacja</h6>
                    <p class="text-muted small" id="last-update">--:--:--</p>
                    <button class="btn btn-primary btn-sm" onclick="refreshMainTrafficMap()">
                        <i class="fas fa-sync me-1"></i>Odśwież
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>Aktywne zakłócenia
                </h5>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    <div class="list-group-item bg-transparent border-0 px-0 py-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">Aleje Jerozolimskie</h6>
                                <p class="mb-1 small">Intensywny ruch w kierunku centrum</p>
                                <small class="text-muted">5 min temu</small>
                            </div>
                            <span class="badge bg-danger">Korek</span>
                        </div>
                    </div>
                    <div class="list-group-item bg-transparent border-0 px-0 py-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">Marszałkowska</h6>
                                <p class="mb-1 small">Utrudnienia na wysokości Centralnego</p>
                                <small class="text-muted">12 min temu</small>
                            </div>
                            <span class="badge bg-warning">Intensywny</span>
                        </div>
                    </div>
                    <div class="list-group-item bg-transparent border-0 px-0 py-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">Wisłostrada</h6>
                                <p class="mb-1 small">Płynny ruch w obu kierunkach</p>
                                <small class="text-muted">3 min temu</small>
                            </div>
                            <span class="badge bg-success">Płynny</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let trafficMap;
let trafficLayers = [];

// Wait for everything to load
function waitForLeaflet() {
    if (typeof L !== 'undefined') {
        console.log('Leaflet załadowany pomyślnie');
        initializeTrafficPage();
    } else {
        console.log('Oczekiwanie na Leaflet...');
        setTimeout(waitForLeaflet, 100);
    }
}

// Start when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM załadowany, sprawdzam Leaflet...');
    waitForLeaflet();
});

function initializeTrafficPage() {
    // Update location status
    updateLocationStatus();
    
    // Initialize traffic map
    initTrafficMap();
    
    // Update last update time
    updateLastUpdateTime();
    setInterval(updateLastUpdateTime, 60000); // Update every minute
}

function updateLocationStatus() {
    const locationText = document.getElementById('location-text');
    const locationStatus = document.getElementById('location-status');
    
    if (navigator.geolocation) {
        locationText.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Pobieranie Twojej lokalizacji...';
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                locationText.innerHTML = '<i class="fas fa-map-marker-alt me-2"></i>Mapa pokazuje natężenie ruchu w Twojej okolicy z TomTom API. Dane aktualizowane co 5 minut.';
                locationStatus.className = 'alert alert-success';
            },
            function(error) {
                locationText.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Nie można pobrać lokalizacji. Używana domyślna lokalizacja.';
                locationStatus.className = 'alert alert-warning';
            }
        );
    } else {
        locationText.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Geolokalizacja nie jest obsługiwana. Używana domyślna lokalizacja.';
        locationStatus.className = 'alert alert-warning';
    }
}

function initTrafficMap() {
    try {
        // Domyślna lokalizacja - Warszawa
        trafficMap = L.map('main-traffic-map').setView([52.237049, 21.017532], 12);

        // Dodaj ciemną mapę
        L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png', {
            attribution: '© Stadia Maps © OpenMapTiles © OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(trafficMap);

        // Spróbuj uzyskać lokalizację użytkownika
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    trafficMap.setView([lat, lng], 13);
                    
                    // Dodaj marker lokalizacji użytkownika
                    L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'user-location-icon',
                            html: '<div style="background-color: #007bff; width: 12px; height: 12px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,123,255,0.5);"></div>',
                            iconSize: [18, 18],
                            iconAnchor: [9, 9]
                        })
                    }).addTo(trafficMap)
                    .bindPopup('Twoja lokalizacja')
                    .openPopup();
                },
                function(error) {
                    console.log('Błąd geolokalizacji:', error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000
                }
            );
        }

        // Symuluj dane o ruchu
        generateTrafficData();
        
    } catch (error) {
        console.error('Błąd inicjalizacji mapy ruchu:', error);
        const container = document.getElementById('main-traffic-map');
        if (container) {
            container.innerHTML = `
                <div style="padding: 40px; text-align: center; color: #dc3545; background: #f8f9fa; border-radius: 8px; border: 2px dashed #dee2e6;">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <h4>Nie udało się załadować mapy ruchu</h4>
                    <p class="mb-3">Problem z inicjalizacją mapy. Spróbuj ponownie.</p>
                    <button class="btn btn-primary" onclick="location.reload()">
                        <i class="fas fa-sync me-1"></i>Odśwież stronę
                    </button>
                </div>
            `;
        }
    }
}

function generateTrafficData() {
    // Wyczyść poprzednie dane
    trafficLayers.forEach(layer => trafficMap.removeLayer(layer));
    trafficLayers = [];
    
    const center = trafficMap.getCenter();
    const currentHour = new Date().getHours();
    const isRushHour = (currentHour >= 7 && currentHour <= 9) || (currentHour >= 16 && currentHour <= 18);
    
    // Nazwy ulic w Warszawie
    const streetNames = [
        'Aleje Jerozolimskie', 'Marszałkowska', 'Wisłostrada', 'Krakowskie Przedmieście',
        'Nowy Świat', 'Al. Solidarności', 'Puławska', 'Grochowska', 'Wołoska',
        'Al. Jana Pawła II', 'Targowa', 'Okopowa', 'Chłodna', 'Grójecka'
    ];
    
    let trafficStats = { light: 0, moderate: 0, heavy: 0, jam: 0 };
    
    // Generuj segmenty ruchu
    for (let i = 0; i < 15; i++) {
        const startLat = center.lat + (Math.random() - 0.5) * 0.03;
        const startLng = center.lng + (Math.random() - 0.5) * 0.03;
        const endLat = startLat + (Math.random() - 0.5) * 0.01;
        const endLng = startLng + (Math.random() - 0.5) * 0.01;
        
        let level = 'light';
        let speed = 45;
        let color = '#28a745';
        let weight = 3;
        
        if (isRushHour) {
            const random = Math.random();
            if (random < 0.15) {
                level = 'jam';
                speed = Math.floor(Math.random() * 10) + 5;
                color = '#dc3545';
                weight = 6;
                trafficStats.jam++;
            } else if (random < 0.4) {
                level = 'heavy';
                speed = Math.floor(Math.random() * 15) + 15;
                color = '#fd7e14';
                weight = 5;
                trafficStats.heavy++;
            } else if (random < 0.7) {
                level = 'moderate';
                speed = Math.floor(Math.random() * 20) + 25;
                color = '#ffc107';
                weight = 4;
                trafficStats.moderate++;
            } else {
                trafficStats.light++;
            }
        } else {
            const random = Math.random();
            if (random < 0.05) {
                level = 'moderate';
                speed = Math.floor(Math.random() * 15) + 30;
                color = '#ffc107';
                weight = 4;
                trafficStats.moderate++;
            } else {
                trafficStats.light++;
            }
        }
        
        const line = L.polyline([[startLat, startLng], [endLat, endLng]], {
            color: color,
            weight: weight,
            opacity: 0.8
        }).addTo(trafficMap);
        
        const streetName = streetNames[i % streetNames.length];
        line.bindPopup(`
            <div>
                <strong>${streetName}</strong><br>
                Natężenie: ${getTrafficLevelName(level)}<br>
                Aktualna prędkość: ${speed} km/h<br>
                <small>Dane symulowane</small>
            </div>
        `);
        
        trafficLayers.push(line);
    }
    
    // Aktualizuj statystyki
    updateTrafficStats(trafficStats);
}

function getTrafficLevelName(level) {
    const names = {
        'light': 'Płynny',
        'moderate': 'Umiarkowany', 
        'heavy': 'Intensywny',
        'jam': 'Korek'
    };
    return names[level] || 'Nieznany';
}

function updateTrafficStats(stats) {
    const total = stats.light + stats.moderate + stats.heavy + stats.jam;
    if (total > 0) {
        document.getElementById('smooth-count').textContent = Math.round((stats.light / total) * 100) + '%';
        document.getElementById('moderate-count').textContent = Math.round((stats.moderate / total) * 100) + '%';
        document.getElementById('heavy-count').textContent = Math.round((stats.heavy / total) * 100) + '%';
        document.getElementById('jam-count').textContent = Math.round((stats.jam / total) * 100) + '%';
    }
}

function refreshMainTrafficMap() {
    if (trafficMap) {
        generateTrafficData();
        updateLastUpdateTime();
        
        const btn = document.querySelector('button[onclick="refreshMainTrafficMap()"] i');
        if (btn) {
            btn.classList.add('fa-spin');
            setTimeout(() => {
                btn.classList.remove('fa-spin');
            }, 1000);
        }
    }
}

function updateLastUpdateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('pl-PL');
    const lastUpdateElement = document.getElementById('last-update');
    if (lastUpdateElement) {
        lastUpdateElement.textContent = timeString;
    }
}
</script>
{% endblock %}
