
{% extends "base.html" %}

{% block title %}Mapa zdarzeń{% endblock %}

{% block head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1><i class="fas fa-map-marked-alt me-2"></i>Mapa zdarzeń drogowych</h1>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body p-0">
                    <div id="map" style="height: 600px; width: 100%;"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            {% if session.user_id %}
            <div class="card mb-3">
                <div class="card-header">
                    <h5><i class="fas fa-plus-circle me-2"></i>Dodaj zdarzenie</h5>
                </div>
                <div class="card-body">
                    <form id="incident-form">
                        <div class="mb-3">
                            <label for="license-plate" class="form-label">Numer rejestracyjny</label>
                            <input type="text" class="form-control" id="license-plate" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="incident-type" class="form-label">Typ zdarzenia</label>
                            <select class="form-select" id="incident-type" required>
                                <option value="">Wybierz typ</option>
                                <option value="aggressive_driving">Agresywna jazda</option>
                                <option value="poor_parking">Złe parkowanie</option>
                                <option value="traffic_violation">Naruszenie przepisów</option>
                                <option value="other">Inne</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="severity" class="form-label">Poziom zagrożenia</label>
                            <select class="form-select" id="severity">
                                <option value="1">1 - Niewielkie</option>
                                <option value="2">2 - Umiarkowane</option>
                                <option value="3" selected>3 - Średnie</option>
                                <option value="4">4 - Wysokie</option>
                                <option value="5">5 - Bardzo wysokie</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Opis zdarzenia</label>
                            <textarea class="form-control" id="description" rows="3" required></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Kliknij na mapę, aby wybrać lokalizację zdarzenia
                            </small>
                            <div id="selected-location" class="mt-2"></div>
                        </div>
                        
                        <button type="submit" class="btn btn-danger w-100" disabled id="submit-incident">
                            <i class="fas fa-exclamation-triangle me-1"></i>Dodaj zdarzenie
                        </button>
                    </form>
                </div>
            </div>
            {% endif %}
            
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-list me-2"></i>Ostatnie zdarzenia</h5>
                </div>
                <div class="card-body">
                    <div class="incident-list" style="max-height: 400px; overflow-y: auto;">
                        {% for incident in incidents %}
                        <div class="incident-item mb-3 p-2 border rounded" data-lat="{{ incident.latitude }}" data-lng="{{ incident.longitude }}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>{{ incident.license_plate }}</strong>
                                    <span class="badge bg-{% if incident.incident_type == 'aggressive_driving' %}danger{% elif incident.incident_type == 'poor_parking' %}warning{% elif incident.incident_type == 'traffic_violation' %}primary{% else %}secondary{% endif %} ms-2">
                                        {% if incident.incident_type == 'aggressive_driving' %}Agresywna jazda
                                        {% elif incident.incident_type == 'poor_parking' %}Złe parkowanie
                                        {% elif incident.incident_type == 'traffic_violation' %}Naruszenie przepisów
                                        {% else %}Inne{% endif %}
                                    </span>
                                </div>
                                <small class="text-muted">{{ incident.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
                            </div>
                            <p class="mb-1 mt-2">{{ incident.description[:100] }}{% if incident.description|length > 100 %}...{% endif %}</p>
                            <div class="severity-bar">
                                <small>Zagrożenie: </small>
                                {% for i in range(1, 6) %}
                                    <i class="fas fa-circle {% if i <= incident.severity %}text-danger{% else %}text-muted{% endif %}" style="font-size: 0.5rem;"></i>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let map;
let selectedLocation = null;
let markers = [];
let tempMarker = null;

function initMap() {
    // Domyślna lokalizacja - Warszawa
    map = L.map('map').setView([52.237049, 21.017532], 10);

    // Dodaj kafelki OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Dodaj znaczniki dla istniejących zdarzeń
    {% for incident in incidents %}
    addIncidentMarker(
        {{ incident.latitude }}, 
        {{ incident.longitude }}, 
        '{{ incident.license_plate }}',
        '{{ incident.incident_type }}',
        '{{ incident.description|e }}',
        {{ incident.severity }},
        '{{ incident.created_at.strftime('%d.%m.%Y %H:%M') }}'
    );
    {% endfor %}

    // Nasłuchuj kliknięć na mapę
    {% if session.user_id %}
    map.on('click', function(e) {
        selectedLocation = {
            lat: e.latlng.lat,
            lng: e.latlng.lng
        };
        
        // Usuń poprzedni znacznik tymczasowy
        if (tempMarker) {
            map.removeLayer(tempMarker);
        }
        
        // Dodaj nowy znacznik tymczasowy
        tempMarker = L.marker([selectedLocation.lat, selectedLocation.lng], {
            icon: L.divIcon({
                className: 'custom-div-icon',
                html: '<div style="background-color: #FFA500; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;"></div>',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            })
        }).addTo(map);
        
        document.getElementById('selected-location').innerHTML = 
            '<small class="text-success"><i class="fas fa-map-marker-alt me-1"></i>Lokalizacja wybrana</small>';
        
        document.getElementById('submit-incident').disabled = false;
    });
    {% endif %}
}

function addIncidentMarker(lat, lng, licensePlate, type, description, severity, date) {
    const iconColors = {
        'aggressive_driving': '#DC3545',
        'poor_parking': '#FFC107',
        'traffic_violation': '#0D6EFD',
        'other': '#6C757D'
    };
    
    const marker = L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'custom-div-icon',
            html: `<div style="background-color: ${iconColors[type] || '#6C757D'}; width: 25px; height: 25px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">!</div>`,
            iconSize: [25, 25],
            iconAnchor: [12, 12]
        })
    }).addTo(map);
    
    const popupContent = `
        <div>
            <h6><strong>${licensePlate}</strong></h6>
            <p><strong>Typ:</strong> ${getIncidentTypeName(type)}</p>
            <p><strong>Opis:</strong> ${description}</p>
            <p><strong>Zagrożenie:</strong> ${'★'.repeat(severity)}${'☆'.repeat(5-severity)}</p>
            <p><small><strong>Data:</strong> ${date}</small></p>
        </div>
    `;
    
    marker.bindPopup(popupContent);
    
    markers.push(marker);
}

function getIncidentTypeName(type) {
    const types = {
        'aggressive_driving': 'Agresywna jazda',
        'poor_parking': 'Złe parkowanie',
        'traffic_violation': 'Naruszenie przepisów',
        'other': 'Inne'
    };
    return types[type] || 'Nieznany';
}

{% if session.user_id %}
document.getElementById('incident-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!selectedLocation) {
        showAlert('Wybierz lokalizację na mapie!', 'warning');
        return;
    }
    
    const formData = {
        license_plate: document.getElementById('license-plate').value,
        latitude: selectedLocation.lat,
        longitude: selectedLocation.lng,
        incident_type: document.getElementById('incident-type').value,
        description: document.getElementById('description').value,
        severity: document.getElementById('severity').value
    };
    
    fetch('/api/add_incident', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            // Reset form
            document.getElementById('incident-form').reset();
            selectedLocation = null;
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }
            document.getElementById('selected-location').innerHTML = '';
            document.getElementById('submit-incident').disabled = true;
            
            // Reload page to show new incident
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert(data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Wystąpił błąd podczas dodawania zdarzenia!', 'danger');
    });
});
{% endif %}

// Highlight incident on map when clicking in list
document.querySelectorAll('.incident-item').forEach(item => {
    item.addEventListener('click', function() {
        const lat = parseFloat(this.dataset.lat);
        const lng = parseFloat(this.dataset.lng);
        
        map.setCenter({ lat: lat, lng: lng });
        map.setZoom(15);
        
        // Find and click the corresponding marker
        markers.forEach(marker => {
            const pos = marker.getLatLng();
            if (Math.abs(pos.lat - lat) < 0.0001 && Math.abs(pos.lng - lng) < 0.0001) {
                marker.openPopup();
            }
        });
    });
});
</script>

<!-- Initialize map when page loads -->
<script>
document.addEventListener('DOMContentLoaded', initMap);
</script>
{% endblock %}
